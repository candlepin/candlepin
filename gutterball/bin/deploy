#! /bin/bash

APP="gutterball"

# Source useful bash functions
source "$(buildr -s checkout_root)/bin/bash_functions"
PROJECT_DIR="$(project_directory gutterball)"
TC="$(which_tomcat)"

clean_up() {
    cd "$START_DIR"
}

validate_options() {
    if [ -n "$USE_ORACLE" -a -n "$USE_MYSQL" ]; then
        err_msg "You can't use Oracle and MySQL at the same time."
        exit 1
    fi
}

usage() {
    cat <<HELP
    usage: deploy [options]

    OPTIONS:
      -q  quiet; no notifications and minimal output
      -t  hot deploy; do not stop and start Tomcat
      -g  regenerate database
      -m  deploy to MySQL
      -o  deploy to Oracle
      -l  logdriver; compile with Logdriver
      -a  install an auto-generated gutterball.conf file
HELP
}

autoconf() {
    # "development" is the default buildr environment.  It has been aliased
    # to the postgresql environment in profiles.yaml
    local buildr_env="development"
    local use_logdriver="$1"
    if [ -n "$USE_ORACLE" ]; then
        buildr_env="oracle"
    elif [ -n "$USE_MYSQL" ]; then
        buildr_env="mysql"
    fi

    buildr -s -e $buildr_env erb $use_logdriver

    if [ "$?" -ne "0" ]; then
        err_msg "ERROR: gutterball.conf generation failed!"
        return 1
    fi

    GUTTERBALL_CONF="/etc/gutterball/gutterball.conf"

    if [ ! -e $GUTTERBALL_CONF ] || $(sudo head -n 1 $GUTTERBALL_CONF | grep -q "AUTOGENERATED"); then
        sudo cp $PROJECT_DIR/target/generated/erb/gutterball.conf $GUTTERBALL_CONF
        info_msg "Installed auto-generated gutterball.conf"
    else
        warn_msg "Your gutterball.conf does not appear to be autogenerated.  Cowardly refusing to overwrite."
    fi
}

### Main

# At the end of the script go back to where we started.
# See http://linux.die.net/Bash-Beginners-Guide/sect_12_02.html
START_DIR="$(pwd)"
trap clean_up EXIT INT TERM

# Abort on errors
set -e

LOGDRIVER=""

while getopts ":qtlmoga" opt; do
    case $opt in
        q  ) QUIET="1";;
        t  ) HOTDEPLOY="1";;
        l  ) LOGDRIVER="logdriver=yes";;
        m  ) USE_MYSQL="1";;
        o  ) USE_ORACLE="1";;
        g  ) GENDB="1";;
        a  ) AUTOCONF="1";;
        ?  ) usage; exit;;
    esac
done

shift $(($OPTIND - 1))
validate_options
build_project $LOGDRIVER
stop_container "$HOTDEPLOY" $TC
deploy_project $APP $PROJECT_DIR $TC
generate_db_for_project $APP $PROJECT_DIR "$GENDB" "$USE_ORACLE" "$USE_MYSQL" "$DBPASSWORD"
if [ -n "$AUTOCONF" ]; then
   autoconf $LOGDRIVER
fi
start_container $APP "$HOTDEPLOY" $TC
notify "$QUIET"
clean_up
