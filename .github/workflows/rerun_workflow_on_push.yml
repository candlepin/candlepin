---
name: Rerun affected workflows in long lived branches on push

on:
  push:
#    branches:
#      - main
#      - candlepin-*-HOTFIX

jobs:
  rerun-workflows:
    runs-on: ubuntu-latest
    steps:
      - name: Mask secrets
        shell: bash
        run: |
          echo "::add-mask::${{ secrets.GITHUB_TOKEN }}"

#      - name: Get PR info
#        uses: 8BitJonny/gh-get-current-pr@2.2.0
#        id: PR
#        with:
#          github-token: ${{ github.token }}

      - name: Rerun workflows
#        if: $PR_LABEL == *"skip CI"*
        shell: bash
        run: |
          token="${{ secrets.GITHUB_TOKEN }}" | awk '{ printf "%s", $0 }'
          base="${GITHUB_REF#refs/heads/}" | awk '{ printf "%s", $0 }'
          echo "$base"

          pr_head_shas=$(gh api \
          -H "Accept: application/vnd.github+json" \
          -H "X-GitHub-Api-Version: 2022-11-28" \
          /repos/candlepin/candlepin/pulls | \
          jq -r '.[] | select(.base.ref == "sbakaj/workflow_rerun") | .head.sha')

          for head_sha in $pr_head_shas; do
            runner_id=$(gh api \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            /repos/candlepin/candlepin/actions/workflows/pr_verification.yml/runs?head_sha=$head_sha | \
            jq -r '.workflow_runs[] | .id')
            runner_ids+=($runner_id)
          done
          
          
          for id in "${runner_ids[@]}"; do
            gh api \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            /repos/candlepin/candlepin/actions/runs/$id/rerun
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
#          PR_LABEL: ${{ steps.PR.outputs.pr_labels }}
