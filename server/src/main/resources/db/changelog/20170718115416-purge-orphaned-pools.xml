<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.5.xsd">

    <changeSet id="20170718115416-1" author="vrjain">
        <comment> purge orphaned stack derived pools. the innermost query is the most important one.
            we are trying to purge orphaned pools, but we need to ensure the dependency chain
            of the pools is purged too.</comment>
        <sql>
             delete from cp2_pool_provided_products
             where pool_id in (
                 select id from cp_pool
                 where sourceentitlement_id in (
                     select id from cp_entitlement
                     where pool_id in (
                         select id from  (
                             select p.id from cp_pool p
                             left outer join cp_pool_source_stack ss
                             on p.id = ss.derivedpool_id
                             where p.type='STACK_DERIVED'
                             and ss.derivedpool_id is null
                         ) as x
                     )
                 )
             );

             delete from cp2_pool_source_sub
             where pool_id in (
                 select id from cp_pool
                 where sourceentitlement_id in (
                     select id from cp_entitlement
                     where pool_id in (
                         select id from  (
                             select p.id from cp_pool p
                             left outer join cp_pool_source_stack ss
                             on p.id = ss.derivedpool_id
                             where p.type='STACK_DERIVED'
                             and ss.derivedpool_id is null
                         ) as x
                     )
                 )
             );

             delete from cp2_pool_derprov_products
             where pool_id in (
                 select id from cp_pool
                 where sourceentitlement_id in (
                     select id from cp_entitlement
                     where pool_id in (
                         select id from  (
                             select p.id from cp_pool p
                             left outer join cp_pool_source_stack ss
                             on p.id = ss.derivedpool_id
                             where p.type='STACK_DERIVED'
                             and ss.derivedpool_id is null
                         ) as x
                     )
                 )
             );

             delete from cp_pool
             where sourceentitlement_id in (
                 select id from cp_entitlement
                 where pool_id in (
                     select id from (
                         select p.id from cp_pool p
                         left outer join cp_pool_source_stack ss
                         on p.id = ss.derivedpool_id
                         where p.type='STACK_DERIVED'
                         and ss.derivedpool_id is null
                     ) as x
                 )
             );

             delete from cp_ent_certificate
             where entitlement_id in (
                 select id from cp_entitlement
                 where pool_id in (
                     select id from (
                         select p.id from cp_pool p
                         left outer join cp_pool_source_stack ss
                         on p.id = ss.derivedpool_id
                         where p.type='STACK_DERIVED'
                         and ss.derivedpool_id is null
                     ) as x
                 )
             );

             delete from cp_entitlement
             where pool_id in (
                 select id from (
                     select p.id from cp_pool p
                     left outer join cp_pool_source_stack ss
                     on p.id = ss.derivedpool_id
                     where p.type='STACK_DERIVED'
                     and ss.derivedpool_id is null
                 ) as x
             );

             delete from cp2_pool_provided_products
             where pool_id in (
                 select id from (
                     select p.id from cp_pool p
                     left outer join cp_pool_source_stack ss
                     on p.id = ss.derivedpool_id
                     where p.type='STACK_DERIVED'
                     and ss.derivedpool_id is null
                 ) as x
             );

             delete from cp2_pool_source_sub
             where pool_id in (
                 select id from (
                     select p.id from cp_pool p
                     left outer join cp_pool_source_stack ss
                     on p.id = ss.derivedpool_id
                     where p.type='STACK_DERIVED'
                     and ss.derivedpool_id is null
                 ) as x
             );

             delete from cp2_pool_derprov_products
             where pool_id in (
                 select id from (
                     select p.id from cp_pool p
                     left outer join cp_pool_source_stack ss
                     on p.id = ss.derivedpool_id
                     where p.type='STACK_DERIVED'
                     and ss.derivedpool_id is null
                 ) as x
             );

             delete from cp_pool
             where id in (
                 select id from (
                     select p.id from cp_pool p
                     left outer join cp_pool_source_stack ss
                     on p.id = ss.derivedpool_id
                     where p.type='STACK_DERIVED'
                     and ss.derivedpool_id is null
                 ) as x
             );
       </sql>
      <comment> purge orphaned bonus pools </comment>
        <sql>
             delete from cp2_pool_provided_products
             where pool_id in (
                 select id from cp_pool
                 where sourceentitlement_id in (
                     select id from cp_entitlement
                     where pool_id in (
                         select p.id from cp_pool p
                         where id not in (
                             select id from (
                                 select s.pool_id
                                 from cp2_pool_source_sub s
                             ) as x
                         )
                         and type = 'BONUS'
                     )
                 )
             );

             delete from cp2_pool_source_sub
             where pool_id in (
                 select id from cp_pool
                 where sourceentitlement_id in (
                     select id from cp_entitlement
                     where pool_id in (
                         select p.id from cp_pool p
                         where id not in (
                             select id from (
                                 select s.pool_id
                                 from cp2_pool_source_sub s
                             ) as x
                         )
                         and type = 'BONUS'
                     )
                 )
             );

             delete from cp2_pool_derprov_products
             where pool_id in (
                 select id from cp_pool
                 where sourceentitlement_id in (
                     select id from cp_entitlement
                     where pool_id in (
                         select p.id from cp_pool p
                         where id not in (
                             select id from (
                                 select s.pool_id
                                 from cp2_pool_source_sub s
                             ) as x
                         )
                         and type = 'BONUS'
                     )
                 )
             );

             delete from cp_pool
             where sourceentitlement_id in (
                 select id from cp_entitlement
                 where pool_id in (
                     select id from (
                         select p.id from cp_pool p
                         where id not in (
                             select pool_id
                             from cp2_pool_source_sub
                         )
                         and type = 'BONUS'
                     ) as x
                 )
             );

             delete from cp_ent_certificate
             where entitlement_id in (
                 select id from cp_entitlement
                 where pool_id in (
                     select id from (
                         select p.id from cp_pool p
                         where id not in (
                             select pool_id
                             from cp2_pool_source_sub
                         )
                         and type = 'BONUS'
                     ) as x
                 )
             );

             delete from cp_entitlement
             where pool_id in (
                 select id from (
                     select p.id from cp_pool p
                     where id not in (
                         select pool_id
                         from cp2_pool_source_sub
                     )
                     and type = 'BONUS'
                 ) as x
             );

             delete from cp2_pool_provided_products
             where pool_id in (
                 select id from (
                     select p.id from cp_pool p
                     where id not in (
                         select pool_id
                         from cp2_pool_source_sub
                     )
                     and type = 'BONUS'
                 ) as x
             );

             delete from cp2_pool_derprov_products
             where pool_id in (
                 select id from (
                     select p.id from cp_pool p
                     where id not in (
                         select pool_id
                         from cp2_pool_source_sub
                     )
                     and type = 'BONUS'
                 ) as x
             );

             delete from cp_pool
             where id in (
                 select id from (
                     select p.id from cp_pool p
                     where id not in (
                         select pool_id
                         from cp2_pool_source_sub
                     )
                     and type = 'BONUS'
                 ) as x
             );
       </sql>

    </changeSet>

</databaseChangeLog>
<!-- vim: set expandtab sts=4 sw=4 ai: -->
