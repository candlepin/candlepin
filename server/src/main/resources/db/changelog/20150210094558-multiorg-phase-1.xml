<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd">

    <property name="timestamp.type" value="TIMESTAMP WITHOUT TIME ZONE" dbms="oracle"/>
    <property name="timestamp.type" value="TIMESTAMP WITHOUT TIME ZONE" dbms="postgresql"/>
    <property name="timestamp.type" value="DATETIME" dbms="mysql"/>

    <changeSet id="20150210094558-1" author="crog">
        <comment>multiorg phase 1</comment>



        <!-- cp_org_activationkey_products -->
        <createTable tableName="cp_org_activationkey_products">
            <column name="id" type="varchar(32)"/>
            <column name="created" type="${timestamp.type}"/>
            <column name="updated" type="${timestamp.type}"/>
            <column name="key_id" type="varchar(32)"/>
            <column name="product_id" type="varchar(32)"/>
        </createTable>

        <addPrimaryKey tableName="cp_org_activationkey_products"
            columnNames="id"
            constraintName="cp_org_activationkey_products_pk"/>

        <addUniqueConstraint tableName="cp_org_activationkey_products"
            columnNames="key_id,product_id"
            constraintName="cp_org_activationkey_products_unique"/>

        <addForeignKeyConstraint baseTableName="cp_org_activationkey_products"
            baseColumnNames="key_id"
            referencedColumnNames="id"
            referencedTableName="cp_activation_key"/>

        <addForeignKeyConstraint baseTableName="cp_org_activationkey_products"
            baseColumnNames="product_id"
            referencedColumnNames="id"
            referencedTableName="cp_org_products"/>



        <!-- cp_org_branding -->
        <createTable tableName="cp_org_branding">
            <column name="id" type="varchar(32)"/>
            <column name="created" type="${timestamp.type}"/>
            <column name="updated" type="${timestamp.type}"/>
            <column name="product_id" type="varchar(32)"/>
            <column name="type" type="varchar(32)"/>
            <column name="name" type="varchar(255)"/>
        </createTable>

        <addPrimaryKey tableName="cp_org_branding"
            columnNames="id"
            constraintName="cp_org_branding_pk"/>

        <addForeignKeyConstraint baseTableName="cp_org_branding"
            baseColumnNames="product_id"
            referencedColumnNames="id"
            referencedTableName="cp_org_products"/>

        <addNotNullConstraint tableName="cp_org_branding"
            columnName="type"/>

        <addNotNullConstraint tableName="cp_org_branding"
            columnName="name"/>



        <!-- cp_org_content -->
        <createTable tableName="cp_org_content">
            <column name="id" type="varchar(32)"/>
            <column name="created" type="${timestamp.type}"/>
            <column name="updated" type="${timestamp.type}"/>
            <column name="owner_id" type="varchar(32)"/>
            <column name="contenturl" type="varchar(255)"/>
            <column name="gpgurl" type="varchar(255)"/>
            <column name="label" type="varchar(255)"/>
            <column name="metadataexpire" type="bigint"/>
            <column name="name" type="varchar(255)"/>
            <column name="releasever" type="varchar(255)"/>
            <column name="requiredtags" type="varchar(255)"/>
            <column name="type" type="varchar(255)"/>
            <column name="vendor" type="varchar(255)"/>
            <column name="arches" type="varchar(255)"/>
        </createTable>

        <addPrimaryKey tableName="cp_org_content"
            columnNames="id"
            constraintName="cp_org_content_pk"/>

        <addForeignKeyConstraint baseTableName="cp_org_content"
            baseColumnNames="owner_id"
            referencedColumnNames="id"
            referencedTableName="cp_owner"/>

        <addNotNullConstraint tableName="cp_org_content"
            columnName="label"/>

        <addNotNullConstraint tableName="cp_org_content"
            columnName="name"/>

        <addNotNullConstraint tableName="cp_org_content"
            columnName="type"/>

        <addNotNullConstraint tableName="cp_org_content"
            columnName="vendor"/>



        <!-- cp_org_content_modified_products -->
        <createTable tableName="cp_org_content_modified_products">
            <column name="content_id" type="varchar(32)"/>
            <column name="element" type="varchar(255)"/>
        </createTable>

        <addPrimaryKey tableName="cp_org_content_modified_products"
            columnNames="content_id"
            constraintName="cp_org_content_modified_products_pk"/>

        <addForeignKeyConstraint baseTableName="cp_org_content_modified_products"
            baseColumnNames="content_id"
            referencedColumnNames="id"
            referencedTableName="cp_org_content"/>



        <!-- cp_org_environment_content -->
        <createTable tableName="cp_org_environment_content">
            <column name="id" type="varchar(32)"/>
            <column name="created" type="${timestamp.type}"/>
            <column name="updated" type="${timestamp.type}"/>
            <column name="content_id" type="varchar(32)"/>
            <column name="environment_id" type="varchar(32)"/>
            <column name="enabled" type="boolean"/>
        </createTable>

        <addPrimaryKey tableName="cp_org_environment_content"
            columnNames="id"
            constraintName="cp_org_environment_content_pk"/>

        <addForeignKeyConstraint baseTableName="cp_org_environment_content"
            baseColumnNames="content_id"
            referencedColumnNames="id"
            referencedTableName="cp_org_content"/>

        <addForeignKeyConstraint baseTableName="cp_org_environment_content"
            baseColumnNames="environment_id"
            referencedColumnNames="id"
            referencedTableName="cp_environment"/>

        <addUniqueConstraint tableName="cp_org_environment_content"
            columnNames="content_id, environment_id"
            constraintName="cp_org_environment_content_unique"/>



        <!-- cp_org_installed_products -->
        <createTable tableName="cp_org_installed_products">
            <column name="id" type="varchar(32)"/>
            <column name="created" type="${timestamp.type}"/>
            <column name="updated" type="${timestamp.type}"/>
            <column name="consumer_id" type="varchar(32)"/>
            <column name="product_id" type="varchar(32)"/>
        </createTable>

        <addPrimaryKey tableName="cp_org_installed_products"
            columnNames="id"
            constraintName="cp_org_installed_products_pk"/>

        <addForeignKeyConstraint baseTableName="cp_org_installed_products"
            baseColumnNames="consumer_id"
            referencedColumnNames="id"
            referencedTableName="cp_consumer"/>

        <addForeignKeyConstraint baseTableName="cp_org_installed_products"
            baseColumnNames="product_id"
            referencedColumnNames="id"
            referencedTableName="cp_org_products"/>

        <addUniqueConstraint tableName="cp_org_installed_products"
            columnNames="consumer_id, product_id"
            constraintName="cp_org_installed_products_unique"/>



        <!-- cp_org_products -->
        <createTable tableName="cp_org_products">
            <column name="id" type="varchar(32)"/>
            <column name="created" type="${timestamp.type}"/>
            <column name="updated" type="${timestamp.type}"/>
            <column name="multiplier" type="int"/>
            <column name="owner_id" type="varchar(32)"/>
            <column name="product_id" type="varchar(32)"/>
            <column name="product_name" type="varchar(255)"/>
        </createTable>

        <addPrimaryKey tableName="cp_org_products"
            columnNames="id"
            constraintName="cp_org_products_pk"/>

        <addForeignKeyConstraint baseTableName="cp_org_products"
            baseColumnNames="consumer_id"
            referencedColumnNames="id"
            referencedTableName="cp_consumer"/>

        <addForeignKeyConstraint baseTableName="cp_org_products"
            baseColumnNames="product_id"
            referencedColumnNames="id"
            referencedTableName="cp_org_products"/>

        <addUniqueConstraint tableName="cp_org_products"
            columnNames="consumer_id, product_id"
            constraintName="cp_org_products_unique"/>

        <addNotNullConstraint tableName="cp_org_products"
            columnName="product_id"/>

        <addNotNullConstraint tableName="cp_org_products"
            columnName="product_name"/>



        <!-- cp_org_product_attributes -->
        <createTable tableName="cp_org_product_attributes">
            <column name="id" type="varchar(32)"/>
            <column name="created" type="${timestamp.type}"/>
            <column name="updated" type="${timestamp.type}"/>
            <column name="name" type="varchar(255)"/>
            <column name="value" type="varchar(255)"/>
            <column name="product_id" type="varchar(32)"/>
        </createTable>

        <addPrimaryKey tableName="cp_org_product_attributes"
            columnNames="id"
            constraintName="cp_org_product_attributes_pk"/>

        <addForeignKeyConstraint baseTableName="cp_org_product_attributes"
            baseColumnNames="product_id"
            referencedColumnNames="id"
            referencedTableName="cp_org_products"/>

        <addNotNullConstraint tableName="cp_org_product_attributes"
            columnName="name"/>



        <!-- cp_org_product_certificates -->
        <createTable tableName="cp_org_product_certificates">
            <column name="id" type="varchar(32)"/>
            <column name="created" type="${timestamp.type}"/>
            <column name="updated" type="${timestamp.type}"/>
            <column name="cert" type="binary"/>
            <column name="privatekey" type="binary"/>
            <column name="product_id" type="varchar(32)"/>
        </createTable>

        <addPrimaryKey tableName="cp_org_product_certificates"
            columnNames="id"
            constraintName="cp_org_product_certificates_pk"/>

        <addForeignKeyConstraint baseTableName="cp_org_product_certificates"
            baseColumnNames="product_id"
            referencedColumnNames="id"
            referencedTableName="cp_org_products"/>

        <addNotNullConstraint tableName="cp_org_product_certificates"
            columnName="cert"/>

        <addNotNullConstraint tableName="cp_org_product_certificates"
            columnName="privatekey"/>



        <!-- cp_org_product_content -->
        <createTable tableName="cp_org_product_content">
            <column name="product_id" type="varchar(32)"/>
            <column name="content_id" type="varchar(32)"/>
            <column name="enabled" type="boolean"/>
            <column name="created" type="${timestamp.type}"/>
            <column name="updated" type="${timestamp.type}"/>
        </createTable>

        <addPrimaryKey tableName="cp_org_product_certificates"
            columnNames="product_id, content_id"
            constraintName="cp_org_product_certificates_pk"/>

        <addForeignKeyConstraint baseTableName="cp_org_product_certificates"
            baseColumnNames="product_id"
            referencedColumnNames="id"
            referencedTableName="cp_org_products"/>

        <addForeignKeyConstraint baseTableName="cp_org_product_certificates"
            baseColumnNames="content_id"
            referencedColumnNames="id"
            referencedTableName="cp_org_content"/>



        <!-- cp_org_product_dependent_products -->
        <createTable tableName="cp_org_product_dependent_products">
            <column name="product_id" type="varchar(32)"/>
            <column name="element" type="varchar(255)"/>
        </createTable>

        <addPrimaryKey tableName="cp_org_product_dependent_products"
            columnNames="product_id"
            constraintName="cp_org_product_dependent_products_pk"/>

        <addForeignKeyConstraint baseTableName="cp_org_product_dependent_products"
            baseColumnNames="product_id"
            referencedColumnNames="id"
            referencedTableName="cp_org_products"/>



        <!-- cp_pool -->
        <addColumn tableName="cp_pool">
            <column name="product_id" type="varchar(32)"/>
            <column name="derived_product_id" type="varchar(32)"/>
        </addColumn>

        <renameColumn tableName="cp_pool"
            oldColumnName="productid"
            newColumnName="product_id_old"
            remarks="deprecated; obsoleted by product_id"/>

        <renameColumn tableName="cp_pool"
            oldColumnName="derivedproductid"
            newColumnName="derived_product_id_old"
            remarks="deprecated; obsoleted by derived_product_id"/>

        <dropColumn tableName="cp_pool"
            columnName="productname"/>

        <dropColumn tableName="cp_pool"
            columnName="derivedproductname"/>
    </changeSet>

</databaseChangeLog>
