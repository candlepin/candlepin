#! /bin/bash

APP="subservice"

# Source useful bash functions
source "$(buildr -s checkout_root)/bin/bash_functions"
PROJECT_DIR="$(project_directory subservice)"
TC="$(which_tomcat)"
SELF_DIR="${BASH_SOURCE%/*}"
CANDLEPIN_BIN_DIR="$(checkout_directory)/bin"

clean_up() {
    cd "$START_DIR"
}

validate_options() {
    if [ -n "$USE_ORACLE" -a -n "$USE_MYSQL" ]; then
        err_msg "You can't use Oracle and MySQL at the same time."
        exit 1
    fi
}

usage() {
    cat <<HELP
    usage: deploy [options]

    OPTIONS:
      -q  quiet; no notifications and minimal output
      -h  hot deploy; do not stop and start Tomcat
      -t  import test data
      -g  regenerate database
      -m  deploy to MySQL
      -o  deploy to Oracle
      -l  logdriver; compile with Logdriver
HELP
}

### Main

# At the end of the script go back to where we started.
# See http://linux.die.net/Bash-Beginners-Guide/sect_12_02.html
START_DIR="$(pwd)"
trap clean_up EXIT INT TERM

# Abort on errors
set -e

LOGDRIVER=""

while getopts ":qthlmoga" opt; do
    case $opt in
        q  ) QUIET="1";;
        h  ) HOTDEPLOY="1";;
        t  ) TESTDATA="1";;
        l  ) LOGDRIVER="logdriver=yes";;
        m  ) USE_MYSQL="1";;
        o  ) USE_ORACLE="1";;
        g  ) GENDB="1";;
        ?  ) usage; exit;;
    esac
done

shift $(($OPTIND - 1))
validate_options
build_project $LOGDRIVER
stop_container "$HOTDEPLOY" $TC
generate_db_for_project $APP $PROJECT_DIR "$GENDB" "$USE_ORACLE" "$USE_MYSQL" "$DBPASSWORD"
deploy_project $APP $PROJECT_DIR $TC
start_container $APP "$HOTDEPLOY" $TC
sleep 10
upload_test_data $TESTDATA $SELF_DIR $CANDLEPIN_BIN_DIR
notify "$QUIET"
clean_up
